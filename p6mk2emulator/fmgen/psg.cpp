// ---------------------------------------------------------------------------
//	PSG Sound Implementation
//	Copyright (C) cisc 1997, 1999.
// ---------------------------------------------------------------------------
//	$Id: psg.cpp,v 1.10 2002/05/15 21:38:01 cisc Exp $

#include "headers.h"
#include "misc.h"
#include "psg.h"

// ---------------------------------------------------------------------------
//	�R���X�g���N�^�E�f�X�g���N�^
//
PSG::PSG()
{
	SetVolume(0);
	MakeNoiseTable();
	Reset();
	mask = 0x3f;
}

PSG::~PSG()
{

}

// ---------------------------------------------------------------------------
//	PSG ������������(RESET) 
//
void PSG::Reset()
{
	for (int i=0; i<14; i++)
		SetReg(i, 0);
	SetReg(7, 0xff);
	SetReg(14, 0xff);
	SetReg(15, 0xff);
}

// ---------------------------------------------------------------------------
//	�N���b�N���g���̐ݒ�
//
void PSG::SetClock(int clock, int rate)
{
	tperiodbase = int((1 << toneshift ) / 4.0 * clock / rate);
	eperiodbase = int((1 << envshift  ) / 4.0 * clock / rate);
	nperiodbase = int((1 << noiseshift) / 4.0 * clock / rate);
	
	// �e�f�[�^�̍X�V
	int tmp;
	tmp = ((reg[0] + reg[1] * 256) & 0xfff);
	speriod[0] = tmp ? tperiodbase / tmp : tperiodbase;
	tmp = ((reg[2] + reg[3] * 256) & 0xfff);
	speriod[1] = tmp ? tperiodbase / tmp : tperiodbase;
	tmp = ((reg[4] + reg[5] * 256) & 0xfff);
	speriod[2] = tmp ? tperiodbase / tmp : tperiodbase;
	tmp = reg[6] & 0x1f;
	nperiod = tmp ? nperiodbase / tmp / 2 : nperiodbase / 2;
	tmp = ((reg[11] + reg[12] * 256) & 0xffff);
	eperiod = tmp ? eperiodbase / tmp : eperiodbase * 2;
}

// ---------------------------------------------------------------------------
//	�m�C�Y�e�[�u�����쐬����
//



void PSG::MakeNoiseTable()
{
#if 0
	if (!noisetable[0])
	{
		int noise = 14321;
		for (int i=0; i<noisetablesize; i++)
		{
			int n = 0;
			for (int j=0; j<32; j++)
			{
				n = n * 2 + (noise & 1);
				noise = (noise >> 1) | (((noise << 14) ^ (noise << 16)) & 0x10000);
			}
			noisetable[i] = n;
		}
	}
#endif
}

// ---------------------------------------------------------------------------
//	�o�̓e�[�u�����쐬
//	�f���Ƀe�[�u���Ŏ������ق����ȃX�y�[�X�B
//
void PSG::SetVolume(int volume)
{
	double base = 0x4000 / 3.0 * pow(10.0, volume / 40.0);
	for (int i=31; i>=2; i--)
	{
		EmitTable[i] = int(base);
		base /= 1.189207115;
	}
	EmitTable[1] = 0;
	EmitTable[0] = 0;
	MakeEnvelopTable();

	SetChannelMask(~mask);
}

void PSG::SetChannelMask(int c)
{ 
	mask = ~c;
	for (int i=0; i<3; i++)
		olevel[i] = mask & (1 << i) ? EmitTable[(reg[8+i] & 15) * 2 + 1] : 0;
}

// ---------------------------------------------------------------------------
//	�G���x���[�v�g�`�e�[�u��
//
void PSG::MakeEnvelopTable()
{
	// 0 lo  1 up 2 down 3 hi
	static uint8 table1[16*2] =
	{
		2,0, 2,0, 2,0, 2,0, 1,0, 1,0, 1,0, 1,0,
		2,2, 2,0, 2,1, 2,3, 1,1, 1,3, 1,2, 1,0,
	};
	static uint8 table2[4] = {  0,  0, 31, 31 };
//	static uint8 table3[4] = {  0,  1, -1,  0 };
	static uint8 table3[4] = {  0,  1, 255,  0 };

	uint* ptr = enveloptable[0];

	for (int i=0; i<16*2; i++)
	{
		uint8 v = table2[table1[i]];
		
		for (int j=0; j<32; j++)
		{
			*ptr++ = EmitTable[v];
			v += table3[table1[i]];
		}
	}
}

// ---------------------------------------------------------------------------
//	PSG �̃��W�X�^�ɒl���Z�b�g����
//	regnum		���W�X�^�̔ԍ� (0 - 15)
//	data		�Z�b�g����l
//
void PSG::SetReg(uint regnum, uint8 data)
{
	if (regnum < 0x10)
	{
		reg[regnum] = data;
		switch (regnum)
		{
			int tmp;

		case 0:		// ChA Fine Tune
		case 1:		// ChA Coarse Tune
			tmp = ((reg[0] + reg[1] * 256) & 0xfff);
			speriod[0] = tmp ? tperiodbase / tmp : tperiodbase;
			break;
		
		case 2:		// ChB Fine Tune
		case 3:		// ChB Coarse Tune
			tmp = ((reg[2] + reg[3] * 256) & 0xfff);
			speriod[1] = tmp ? tperiodbase / tmp : tperiodbase;	  
			break;
		
		case 4:		// ChC Fine Tune
		case 5:		// ChC Coarse Tune
			tmp = ((reg[4] + reg[5] * 256) & 0xfff);
			speriod[2] = tmp ? tperiodbase / tmp : tperiodbase;	  
			break;

		case 6:		// Noise generator control
			data &= 0x1f;
			nperiod = data ? nperiodbase / data : nperiodbase;
			break;

		case 8:
			olevel[0] = mask & 1 ? EmitTable[(data & 15) * 2 + 1] : 0;
			break;

		case 9:
			olevel[1] = mask & 2 ? EmitTable[(data & 15) * 2 + 1] : 0;
			break;
		
		case 10:
			olevel[2] = mask & 4 ? EmitTable[(data & 15) * 2 + 1] : 0;
			break;

		case 11:	// Envelop period
		case 12:
			tmp = ((reg[11] + reg[12] * 256) & 0xffff);
			eperiod = tmp ? eperiodbase / tmp : eperiodbase * 2;
			break;

		case 13:	// Envelop shape
			ecount = 0;
			envelop = enveloptable[data & 15];
			break;
		}
	}
}

// ---------------------------------------------------------------------------
//
//
inline void PSG::StoreSample(Sample& dest, int32 data)
{
	if (sizeof(Sample) == 2)
		dest = (Sample) Limit(dest + data, 0x7fff, -0x8000);
	else
		dest += data;
}

// ---------------------------------------------------------------------------
//	PCM �f�[�^��f���o��(2ch)
//	dest		PCM �f�[�^��W�J����|�C���^
//	nsamples	�W�J���� PCM �̃T���v����
//
void PSG::Mix(Sample* dest, int nsamples)
{
	uint8 chenable[3], nenable[3];
	uint8 r7 = ~reg[7];

	if ((r7 & 0x3f) | ((reg[8] | reg[9] | reg[10]) & 0x1f))
	{
		chenable[0] = (r7 & 0x01) && (speriod[0] <= (1 << toneshift));
		chenable[1] = (r7 & 0x02) && (speriod[1] <= (1 << toneshift));
		chenable[2] = (r7 & 0x04) && (speriod[2] <= (1 << toneshift));
		nenable[0]  = (r7 >> 3) & 1;
		nenable[1]  = (r7 >> 4) & 1;
		nenable[2]  = (r7 >> 5) & 1;
		
		int noise, sample;
		uint env;
		uint* p1 = ((mask & 1) && (reg[ 8] & 0x10)) ? &env : &olevel[0];
		uint* p2 = ((mask & 2) && (reg[ 9] & 0x10)) ? &env : &olevel[1];
		uint* p3 = ((mask & 4) && (reg[10] & 0x10)) ? &env : &olevel[2];
		
		#define SCOUNT(ch)	(scount[ch] >> (toneshift+oversampling))
		
		if (p1 != &env && p2 != &env && p3 != &env)
		{
			// �G���x���[�v����
			if ((r7 & 0x38) == 0)
			{
				// �m�C�Y����
				for (int i=0; i<nsamples; i++)
				{
					sample = 0;
					for (int j=0; j < (1 << oversampling); j++)
					{
						int x, y, z;
						x = (SCOUNT(0) & chenable[0]) - 1;
						sample += (olevel[0] + x) ^ x;
						scount[0] += speriod[0];
						y = (SCOUNT(1) & chenable[1]) - 1;
						sample += (olevel[1] + y) ^ y;
						scount[1] += speriod[1];
						z = (SCOUNT(2) & chenable[2]) - 1;
						sample += (olevel[2] + z) ^ z;
						scount[2] += speriod[2];
					}
					sample /= (1 << oversampling);
					StoreSample(dest[0], sample);
					StoreSample(dest[1], sample);
					dest += 2;
				}
			}
			else
			{
				// �m�C�Y�L��
				for (int i=0; i<nsamples; i++)
				{
					sample = 0;
					for (int j=0; j < (1 << oversampling); j++)
					{
#ifdef _M_IX86
						noise = noisetable[(ncount >> (noiseshift+oversampling+6)) & (noisetablesize-1)] 
							>> (ncount >> (noiseshift+oversampling+1));
#else
						noise = noisetable[(ncount >> (noiseshift+oversampling+6)) & (noisetablesize-1)] 
							>> (ncount >> (noiseshift+oversampling+1) & 31);
#endif
						ncount += nperiod;

						int x, y, z;
						x = ((SCOUNT(0) & chenable[0]) | (nenable[0] & noise)) - 1;		// 0 or -1
						sample += (olevel[0] + x) ^ x;
						scount[0] += speriod[0];
						y = ((SCOUNT(1) & chenable[1]) | (nenable[1] & noise)) - 1;
						sample += (olevel[1] + y) ^ y;
						scount[1] += speriod[1];
						z = ((SCOUNT(2) & chenable[2]) | (nenable[2] & noise)) - 1;
						sample += (olevel[2] + z) ^ z;
						scount[2] += speriod[2];
					}
					sample /= (1 << oversampling);
					StoreSample(dest[0], sample);
					StoreSample(dest[1], sample);
					dest += 2;
				}
			}

			// �G���x���[�v�̌v�Z�����ڂ������K���킹
			ecount = (ecount >> 8) + (eperiod >> (8-oversampling)) * nsamples;
			if (ecount >= (1 << (envshift+6+oversampling-8)))
			{
				if ((reg[0x0d] & 0x0b) != 0x0a)
					ecount |= (1 << (envshift+5+oversampling-8));
				ecount &= (1 << (envshift+6+oversampling-8)) - 1;
			}
			ecount <<= 8;
		}
		else
		{
			// �G���x���[�v����
			for (int i=0; i<nsamples; i++)
			{
				sample = 0;
				for (int j=0; j < (1 << oversampling); j++)
				{
					env = envelop[ecount >> (envshift+oversampling)];
					ecount += eperiod;
					if (ecount >= (1 << (envshift+6+oversampling)))
					{
						if ((reg[0x0d] & 0x0b) != 0x0a)
							ecount |= (1 << (envshift+5+oversampling));
						ecount &= (1 << (envshift+6+oversampling)) - 1;
					}
#ifdef _M_IX86
					noise = noisetable[(ncount >> (noiseshift+oversampling+6)) & (noisetablesize-1)] 
						>> (ncount >> (noiseshift+oversampling+1));
#else
					noise = noisetable[(ncount >> (noiseshift+oversampling+6)) & (noisetablesize-1)] 
						>> (ncount >> (noiseshift+oversampling+1) & 31);
#endif
					ncount += nperiod;

					int x, y, z;
					x = ((SCOUNT(0) & chenable[0]) | (nenable[0] & noise)) - 1;		// 0 or -1
					sample += (*p1 + x) ^ x;
					scount[0] += speriod[0];
					y = ((SCOUNT(1) & chenable[1]) | (nenable[1] & noise)) - 1;
					sample += (*p2 + y) ^ y;
					scount[1] += speriod[1];
					z = ((SCOUNT(2) & chenable[2]) | (nenable[2] & noise)) - 1;
					sample += (*p3 + z) ^ z;
					scount[2] += speriod[2];
				}
				sample /= (1 << oversampling);
				StoreSample(dest[0], sample);
				StoreSample(dest[1], sample);
				dest += 2;
			}
		}
	}
}

// ---------------------------------------------------------------------------
//	�e�[�u��
//
//uint	PSG::noisetable[noisetablesize] = { 0, };
int		PSG::EmitTable[0x20] = { -1, };
uint	PSG::enveloptable[16][64] = { 0, };
const uint PSG::noisetable[noisetablesize] = {
2414630958,2622125745,3594209131,761515126,2128069316,1693121440,2324779114,148968882,
2713457574,782191217,836434776,2333954996,246553149,962915963,2882175600,1171827037,
102010659,1507270469,2972302023,2834073007,1233729494,4098265774,1812721170,724386764,
645816259,2422663422,2776766917,1063838053,2994322895,2776143949,2092713766,2917010771,
470791704,3074242020,4047215338,4171271441,1554650881,629332420,3748385122,1249227217,
3142298418,2214348294,2936932763,402367498,2584770856,3469081321,145134878,1622405438,
451098807,3979619570,1335736565,2911997419,3710014677,2210514531,1878485013,1679850064,
3381262295,340107945,2483544588,891187379,3644743395,2461461558,2926971863,306556329,
2374491596,1434353730,1084596505,2462051360,777014152,3000319168,3890330675,2793316290,
1885722873,1569592795,559665690,1295629551,2812845189,2001229108,2163425695,603051547,
1195060715,3441589461,3351342178,1861610129,543871200,3383883707,346792706,2542036170,
4226845209,1363020515,280471860,2264092319,980543963,660331802,1421443887,3351800948,
4006849230,2163884425,2748814916,3886791810,2806258986,885093346,1580569457,4015728923,
3334106665,3947307821,3620553852,717635823,2712179589,1858628340,3767775598,3127519713,
1194470909,1292123274,1733426443,76778350,3546992480,4184968795,3684326137,2559573336,
68946486,293022293,3246482370,1986385913,1141778971,1094394603,3567403797,2812386451,
4151186795,543412470,1234679780,3023778411,4259448117,149984665,1644065539,3750121679,
2314786573,3315427828,1729297836,2240760281,928970002,2427218190,3868900984,600594046,
2277657701,3204031119,2488853149,3027612369,3167463410,2619110966,3614885206,3892749326,
437991739,4008323745,1074929709,1347160254,354623703,3519302506,3009429360,1633219101,
2637559025,328904440,176951390,680740207,678020327,1807573668,1947914808,3446537325,
116166319,1510545686,3198558751,1429274874,2173191124,2789416871,2963061111,777374593,
1925340389,2545542319,990505879,585487545,1127098315,1551046367,2798689993,1928748183,
2539971963,3091901616,255334892,1060004299,4084342621,823458467,2283197478,3260999058,
3119263534,1238087538,3042717718,2015874140,2123809382,3858675970,780487240,833911730,
3401379879,2556230807,2271530363,4232709809,238721896,2070203259,4081721137,838531848,
2341819104,212868920,837581614,3419075184,2648274270,1343457326,3561669296,3828988527,
2850588453,1306017116,1679227430,2304661011,2267991498,4252009561,1251881075,2027900369,
1028318256,3128502734,3346722120,2889158256,2614721118,1234417646,3022664257,2107786645,
2850129715,3456007427,3297143631,3812112364,1949225546,3450928569,2242890120,2010436675,
3265684511,4197452152,374089662,1554224918,3852908958,804472863,875688571,499889522,
2958833814,1835527292,784747247,2963847429,780716629,4051770306,3127126522,1191816599,
2380586299,3572122529,2794692206,4092239392,1934679817,3516353509,842595693,2221787885,
1890343182,2660921977,3721352569,5144762,1093247687,2498552751,3062412885,931198145,
2481188406,729236309,654368129,3586343271,578672069,1097343588,1442480392,1117037667,
452442260,2908949623,2664755907,2632382398,2493670165,4154528914,2741770094,627791971,
485996436,3034788791,4273209906,92080196,2494259971,2005357773,66881031,1326266780,
4025985044,2216905303,830864329,175542742,1799873324,936277115,3536473329,3214647546,
2441636820,3796088230,2979937267,1780441393,1929010313,2539119876,948596049,3960155667,
3408819147,3732034525,2387991425,1522669797,1035527597,3113070557,2287326337,1128408869,
1574442332,538333223,2287785111,3278137210,4249388085,1248866776,2069678871,4087619226,
846822862,1165731914,2226146104,3018669612,3813652280,3052220716,4207905016,3582837213,
1666479874,3582247371,3815913309,1964265634,2299811490,2249477922,3117690690,1227208409,
3068114640,3066640118,4137064038,1744829440,100667136,427835328,1616965873,2577137658,
589846,2149990495,2693828969,1785094655,4076871552,817920480,3476158971,252418450,
4293689391,1078534326,3510029046,4036401510,2122302400,1717633009,2149302330,1617555687,
431865765,2694418815,3930071456,1401982697,1520834591,1009903227,1070325874,819821012,
1329772836,786057945,2967452112,2940799286,2532730519,4267967482,101256982,2577825695,
3236979096,4093484549,4077461398,2967878079,1872849042,1701705837,216833967,1888049494,
503788301,4288479476,2173912047,640278343,1361906380,2432657793,1740799077,3338235534,
1784406426,871988750,1125885882,2628286212,3582706130,1666053949,367305019,317435042,
2400475554,2677305570,3652509619,3502131491,3067524806,921663145,1443235599,228171263,
4110422144,692078112,2941323530,2526045800,4293230649,3228524777,1906727839,2599483545,
2373966912,1453360657,1328167361,1868720501,3864084362,3771773385,997649238,2735085455,
618257375,1515264394,3218088008,1354008883,1459553921,2386811814,1520408688,4242114527,
3427827336,3260409217,969076580,2843412043,2410862780,3710375132,1138140742,531574921,
4183232005,2601122711,182816953,3912181449,3740750485,207658737,1922718841,2530207480,
1049387614,4120023532,1798235082,3060807640,1952240279,3429138170,3263751253,3129059395,
2225523486,4088569532,1915149662,3557999148,3847206968,2892828396,2595190793,1276526119,
1667069716,1436713364,1138927156,527577437,2048149794,3067360962,1994774201,1177431883,
1228093183,4135589440,664820880,2540266854,2021641408,2145435697,3766169803,4193390365,
431275955,549441824,1255190729,972484374,2846230431,217161627,4042922377,1071046726,
2964207883,1855154799,1642689318,1608486992,3901334871,2550463499,2249379628,4191129464,
3645759037,1399066490,424230454,3816208214,889680013,1499209238,858226653,1079255170,
1363511849,3511110189,827128383,2304824945,3353046107,1855679099,1640723315,1600065809,
2863366146,3221544971,2954016812,743329467,3123358016,102764368,419970708,1650652660,
2433968815,1611231254,1478990940,4137129572,3892034570,2786074408,834960234,3412128625,
2673602842,448346158,3964317360,171446636,711868907,2736953300,1682111140,2283492411,
40601058,3375691507,2526996082,3218874454,1351059788,3594504032,1836117081,2929691248,
3520711519,1930518442,276900162,3324309339,2837087928,1311554383,725205999,1713995590,
1093640904,2499109776,1994970789,3323555646,1776543542,1039623445,2023771408,3165202182,
3717125594,3243827741,3040194801,3113988090,2282247188,2183349591,671466505,1779851559,
4074511574,935818349,1391201454,520827283,4226681387,289647142,2170438163,2771294410,
2112996635,1757111595,2026065383,1027466469,1001974445,2685243421,3895796848,3671709919,
1573983562,2687504504,684475902,2835482245,239639477,2058373176,3027055340,4239361800,
3449159137,87197948,1434878414,1132177226,2637198584,3549286109,2060732610,3051630906,
2062141607,1964855476,154277629,646241867,3551678141,3123030361,2250231600,2046349069,
4187820020,2551413807,1179201462,3367433526,2432067991,3890494522,1718222823,4030565,
3237568910,1943789146,1402572543,3665844288,2627827474,1437434253,3286066772,2139275460,
3790320418,3218350146,1353025817,3602859553,793954572,4137653872,3889806431,2794495593,
1944477247,2472603505,2841347610,3476617709,2402146765,1601966406,707739977,574018934,
3226919046,2974693947,1768646243,2146910229,539021393,3364582739,1343162393,2487214688,
904950040,3669874725,1549276828,645291991,2420435115,2768410756,2102051888,3933839823,
2474176333,2839381733,3468261934,1229698610,3078370630,1882183752,1555339059,1711241473,
1317157445,1772644228,4241197042,3424452151,2205468499,3977129115,1333475659,3996265341,
1128539946,1572967779,3765842135,2042974056,962883194,3955794549,365994313,305573238,
207036037,2991177143,2780076467,2143240353,554881708,3423600152,54265830,205463137,
3019095582,2737969149,604297739,3641859757,2450386205,750047027,4194176771,428326860,
2692681921,2850260790,3455515926,2225490719,3014704825,573494602,3224428665,2966403576,
2936867228,2549572629,2048936272,3054057238,4121334174,1811145246,892563711,1501634498,
2959358202,1837755863,759548969,2118534063,2793971285,1937792704,2464246962,1866328549,
658038253,3576512716,570315523,2407979214,3724203272,3231048033,846396892,2237089797,
873001493,2636248275,332377720,2345489020,231087471,879358695,482195237,3050942815,
3121654057,113676014,1521195010,4228154891,1326660015,4018677972,1170385252,108662729,
410434774,667376749,384607919,503952151,3215237275,293317194,2175812536,2796363276,
3005169585,3770364203,4207020261,364421549,327986911,181506251,3924961053,1572083122,
566055844,244980345,969863034,2840069684,259135837,1041556259,3084301382,850361353,
1175858983,1239234388,4110651526,3914245690,526987622,4202596802,1466271097,3360650425,
1395527627,410238174,2815564877,918353447,2539447575,3097799963,213622570,4055931745,
2071087965,3004546977,2694025582,3932856800,321925112,1208792095,842136955,72059570,
3493644391,4110160774,785337081,814676314,2383960892,2615638589,1231304314,2009715831,
1121264832,3689011763,1501503041,3013852822,2724599295,553767555,1279737517,3792516380,
4038564148,4277371550,3295865564,2698449349,2875818855,3346820422,3962482250,196154042,
2888306244,464140929,1749181605,4212722622,2460118037,3995151186,3272402847,3169888153,
486455170,885355496,1579455323,1864067515,1739291779,1195846957,3436019708,1074176014,
270215227,3295308513,3769839935,4208986288,355999980,1370393482,1389464779,3757199389,
2285229169,1121592537,1541282387,965734360,677135510,2875589503,121736483,3705034695,
2221722351,4037548292,1049256529,4119531987,2874049338,1206496295,2388450199,3672398010,
2636674244,3555446306,2069220097,1937923781,2464804007,790481333,2008044728,2200782796,
746475203,3135678654,86182103,2512707947,2992815604,621959341,2634937501,326414163,
152016536,3867000773,2691272935,3921422246,1553962864,3847862303,2888863353,1540233851,
969666418,693978644,790776277,3074536739,2966862278,795822441,912717822,2483184133,
4111011990,2842035839,264345699,4243982231,216375225,4038007049,3197608548,2516279563,
1922260079,384411303,2652697399,2683629587,2553216074,2259701304,3144493932,3278890856,
1029989498,4207446261,1435501032,52692954,207167134,2993831389,1700034562,3422879243,
2199046060,3968839512,2300401332,103944061,423935531,591648550,1172285776,2248757014,
967274397,1760847250,4193029935,1506353014,2975218183,1762485916,2121712598,3863396270,
546001235,168792344,3938295845,2421811359,628217947,1553667963,2773129264,2088289997,
4009568900,3226198194,826112740,1220195624,818182634,3475044817,2404112690,1593676421,
3964219062,3392598390,2589358471,3486283902,3435331556,2151366763,551801270,1270330036,
3157468799,3753922656,2297517466,33096462,2275036409,3213861080,2447207252,1661138820,
2496357363,1981765425,100305160,1452574307,1341601813,3961597522,3415012063,2630940617,
2490884820,885158885,3728298862,258677091,3195446230,373761965,3700250460,85330087,
354263221,2435967739,546034002,1242411293,3132467249,2222705354,1894898075,1610289163,
2819785772,1246671290,1000958598,1615851704,422330062,1660679306,324087562,3381721065,
2485641820,899052007,3678165990,2587785571,3463871447,3393483178,3682654913,3638779319,
364224945,2478567082,704725250,579163208,45351986,175968708,2875917155,2272709974,
4228285966,1327217082,2947025028,357179441,1350174921,368484630,312945693,3459611504,
1264104221,1068818611,2973678306,682968368,687359372,2849965905,2366364818,1466795373,
3362616556,1403948682,1515297163,4291952717,12353831,1121789140,3687045734,1509924608,
4051803075,4200991231,385983875,2579955566,2171224673,2784205086,4273111612,1164355710,
79891431,2453466471,2893844167,1525487788,3171886233,3682556737,455261140,708985253,
2744751871,3867164224,1671493265,2523654114,1010132592,2144911453,3767873888,4201744859,
3613017369,2831123744,3369203147,292792926,2173846509,2788007757,4047313636,3099274539,
3435298789,3224985710,1894504866,1603637473,3920832447,3701495568,2242464134,936342649,
1389235451,529248466,3117166462,1229174310,3076404499,1890539785,513192550,1040147713,
2021805381,3156846151,2678911119,2572746269,2201339889,1813671481,3949929321,3613869437,
675595435,3942785925,1455949556,244456045,971829039,2848491381,1297103880,1712652067,
2178335558,3878600138,628185178,479803262,4114780196,1750787224,3145542468,3274434498,
1013278456,2123154015,3851434472,1864690139,2807733528,1958531879,3487332438,3431399246,
2168079081,2762447644,4223109812,3493054590,1958990822,1312799584,2876310362,2266516924,
3181847965,3656736528,296233860,1120576752,462961404,1753670990,3090820201,1323711167,
1747018834,2056112221,1955877730,2406766930,2651616030,3753038012,3374839516,383133383,
1592595116,2886667801,2604661728,170922360,709640638,2745308821,643882993,3491448891,
879489762,481638192,4126773519,3935838332,1355188718,1462470082,3378837115,2546656368,
3134793950,3318933836,2789154657,2977151582,2844919789,204250703,1941528238,302722323,
3433987851,3247596525,4130150220,2772375777,3182667198,2577563541,3235996082,1941823141,
1377307964,484849599,1956729618,263002252,3177128977,3660273987,505918300,3205964197,
3550039806,981690439,1689090828,1268691698,1016948596,2102576140,3927941424,2465819790,
1868294426,649682478,323694387,3388897027,3582345679,2742589261,1698461926,3451846050,
2241087970,3073652210,1897781941,1479548024,919369470,3598894660,4021004418,2235844650,
3024106144,2081474089,4014418221,3335352060,1787224142,2964994345,1858497263,3769118980,
2055915600,4102656855,4010027402,1204923467,2394085948,3647463036,1405521518,1542167074,
4183068163,1527192461,3135088853,2244069731,1987532757,71338657,1343359021,340566719,
337748563,2509169114,3008904988,1639379894,2662756919,3715388498,2190230622,2861695085,
15499695,1133061846,3737572078,3433758464,2172732354,644177912,269232158,1144236670,
2176992101,2809765199,4097315436,770592043,3166873572,473577065,2011583551,2187380209,
3910870715,3727315777,2401491414,1598525740,3939475704,2441964508,1649866118,2446224251,
3813291825,1979339017,2325205092,1224390024,836008770,3408196571,2656760728,2667410052,
1548392112,1715011437,2171454061,1709996334,3469409008,2291750270,4391079,2166145719,
3828628082,1776150357,1023468673,3141774118,2212382291,2945353946,1440317791,3255854376,
4173696489,3710342365,64259651,1336359069,3983879248,3465149015,159750089,3833019093,
3904972258,3644120819,3533589619,3202261714,348988412,3590833932,1839132146,2904296630,
523710965,4212198314,2457889856,4003572243,2167325386,3840981913,721338498,3779375659,
1027859494,979331473,1743420449,3327356815,1759077854,2035535374,2065419194,1923734535,
1443694364,2377604533,363897273,330215050,173085066,2882536008,95685042,398271652,
3676036026,1521063943,4228646430,255007231,3204489601,331525732,200937993,756468902,
4280189362,1136502437,2652500799,534884403,3095309506,266672184,3161269996,3736064520,
1293204643,655875492,1436189176,1124902815,485603227,3036328840,1054106306,4108620731,
1856727555,1627878029,1549538966,644308989,268740619,68389422,3511339568,4051278415,
4189589420,411975003,1679522363,1231763043,4160099351,572904793,1075716147,1350502593,
2514739510,855080085,1197485424,1280884381,578082259,3243139643,4117368929,686998940,
3925321492,2644735383,1373965112,2481810988,1800332090,3085448228,1918557592,3590177029,
1653109844,3531852870,2125447688,1695873187,2367085734,3609118130,3921455015,480098165,
3042029579,3088231468,239999931,984344578,604330504,420757154,1645606177,282241484,
125701443,472364636,3080140005,4088995502,2987015441,1688894209,3414389447,1559041964,
2760842073,3139414960,2193179694,709575091,599774880,1175498537,164009838,1701574754,
217390992,2968074662,4020152562,94177780,2534630831,2039042006,944204973,1863084446,
3891444764,641097591,2438261251,2701562510,1817964186,712589774,595285835,87263486,
3582116292,3815487330,3044290642,2022559069,2081703458,2941520130,377824840,3753234609,
1228551913,1990612511,2268122617,4245619865,2340410176,1327544785,793430320,4143552143,
3864543132,1626796438,2615573055,3378542192,3621373023,1787912298,1893849523,1606357153,
2836629166,3456826128,2343129734,206511801,2989473096,2754943600,3118018398,3373463212,
2517591833,2109621667,2845214694,1279245920,2750486042,2805472748,892235979,3656539933,
2444618673,582669352,3259360681,965144526,2826568905,200708630,1831333084,802572359,
3031216911,1067049215,830602179,174559740,3943146380,2531223249,2127184625,2761661306,
4215835445,1408241176,456932326,1782571360,846233048,3311265813,606132817,3649789907,
273655992,2234337484,905867523,3666237519,2629367597,2513297789,843382187,2239941060,
4151022946,3765743827,969928568,692864574,2942437749,374384521,483833798,879719145,
1554388767,632412603,1605046403,2839971374,1330362674,2935753350,273623225,3308218569,
1710651671,3466885658,3375953645,2527979021,1058857399,3014966963,574608736,1081123033,
299805522,51185564,2365022101,283158961,129666216,1594134923,1809015375,1975079342,
193663699,2899218426,1477024791,4129560410,622418110,488846551,4089716330,870415922,
1132308293,2636772551,334343725,2337133373,1340356666,1818881767,717078565,1616408732,
3648511572,1401065156,1525323936,2098250921,3943113613,3604825812,784485093,2964961583,
2932378357,1351616872,375662586,1544132119,3877912026,1700395039,204578427,4090109553,
869989976,2208122612,781339245,2985147181,2882372221,3318049128,1717895163,2148188176,
3760828487,3098324239,211394431,4047510048,961572360,3944063905,2526275182,1072390179,
1884772485,491303989,846265817,2237646864,1948832325,3450436998,1171237240,2253213628,
950431007,3970969400,1240250159,902426999,441825665,2948827238,3573465986,3871653611,
581162006,1109894492,2551675941,1180184476,1224127894,837253949,1273246266,2104083559,
1794990212,1900730928,3648642639,1404636846,2584377617,3467344387,1225209485,4133296020,
2766347191,3132401715,75467456,3504458163,2009027745,51546028,1284423514,555307710,
203628119,3011821259,586405022,1131652958,2635232429,3540864924,955674007,3991153978,
1290387367,2694615415,1783980416,1942019681,3555937823,993127419,571200786,1085120781,
2459823221,785435337,4042725781,3219234867,2424236226,2783189306,1055482534,1948242480,
1299758157,649911847,3546042134,3114676127,1223767450,4059601677,2073840374,2962635111,
1853713348,1651176928,2435934970,1619652951,436582665,2929166948,3522939658,1938939627,
1386417175,2653221723,2669343160,2611837580,1214166162,862814060,1097769578,367075634,
3539782791,4283171134,48432311,2335495155,3458104115,3422450179,3708179599,2203633437,
3988073904,3451518383,92899799,3611575594,2831156704,154146552,646733406,2475847405,
3937214476,3491743792,1954075341,3439165316,1087021552,320352188,1218884894,817068351,
1323383474,3896288359,452835461,2907278391,3732165586,2387368894,2594338837,3424747090,
1133356765,2664821441,484620212,884110141,3756347448,141300974,598431363,105353132,
3633306968,1411154487,1165305936,3297373015,587585417,1154886599,1114449388,3643793096,
1391758483,1601114473,2858910204,3272075148,1021208531,4232971963,237738818,4213476315,
1381698971,2650469640,2425710944,1718681561,2153758864,1634267749,2650404111,278505855,
2252394401,4170386799,2624124645,2528765487,1061806391,854981777,124423520,1550882521,
1725857491,3268306171,4220127953,281717232,119016892,497431967,1911642906,465124014,
3893011472,438843716,1848306496,2736854994,2756451006,941845591,1854237256,1639248819,
2663313954,2639557634,3523529995,4237428589,225221743,1995003558,102698801,2583428874,
26280938,2250264400,3104386710,3395744254,2600631173,3402199286,1503109092,4030437482,
4242573233,1287274281,1640395631,3748155748,2323337675,192123742,4010977708,126749915,
534491226,3096980860,1279704750,571168019,11501832,3264603233,988997788,2776045653,
3162613571,2636575966,2480041549,3955040932,3558588986,1701443687,217948037,4039711222,
3205898663,1402801908,2593355887,1290354598,3768496498,979200404,1742928948,2255704031,
944893067,794020110,1989924474,1204399223,2396314307,3638975935,2510348689,3018571298,
2740197122,629496264,527708498,2047723805,1991530034,2273070406,3157141067,1605570751,
2837481169,1321876209,1754948985,4165930169,2670719432,460602194,1796072349,922023571,
2523850730,3156223568,1602785493,1774217056,4252075099,3399118969,3637468665,353280154,
293153358,3250250664,3062183496,4155872433,3812308971,4095873621,763416001,4251124855,
2329202883,3387324223,3588243760,2734232718,2740590361,633264546,3751071971,3384178615,
3568583474,2818317318,906983193,1438515619,60262116,3468425770,155260450,2807307522,
881161032,1597280755,1797219249,1991923241,2269629740,2093926394,3959991829,186684369,
1850370993,3803919403,4064419237,899215869,2600860553,181833926,1777329960,1036281194,
4167077105,1603932409,697223130,3965234845,175411667,1800364857,2012107819,2185414052,
3919292410,2617800212,3609445846,1766319660,1062101307,4075429025,923989420,2442095577,
1650357651,3522054955,3015884388,603608585,2266484132,2107295224,3909985949,2658530257,
508212144,1052271148,4115632184,3899499757,2611870349,140285079,1667594104,1431076927,
1080107250,3516713975,4061404450,886404032,1583387633,1847225145,3824105001,4148630829,
2697826813,3942982536,3604334273,1860332213,3761320058,4173893109,1561334952,587487114,
2228243400,2994027984,3846813751,2893319891,1523521785,3180307928,2573041172,1126344660,
474101413,1981306684,2246527293,920975035,2519394112,3173065938,3687635583,3653263200,
2440129114,1637479423,503427843,3213271246,301673227,3281151725,4272751116,2233419953,
893055208,2577760152,1090298247,332246653,2344997481,1306934591,1692498866,1253945381,
3092884639,2406537561,3726594865,268081160,2081736227,4015401223,1183657564,3415732964,
481965865,1975931247,2322125285,3409540078,1579914050,4012157403,123440410,3703101229,
3318573436,1715929006,2156544337,2718668050,3769413903,983165055,616684515,1513560437,
3193021323,2530404044,3204391553,3561177767,605936181,1500520024,865894134,3264668774,
3137218691,1162291245,3293407932,1613164638,2559737197,3295505132,1622077706,2593159272,
3437625273,11436298,1116841067,2598566068,2368953599,394372291,2615605822,2304923253,
2278673483,2125677119,627169395,1558124497,2756418226,4164717671,1593643652,2890600115,
2587818338,2389990354,2588703166,3483564180,2372099191,383100609,2665738934,473380469,
4157674570,2729448504,577525230,2167030465,2766379958,4206266422,1417118420,3301174246,
574575969,7504092,1104585542,388965833,3648478805,327200449,182620340,1764943612,
3196527181,3585950116,597317369,2257571416,2073873143,4036237666,1047880656,1984485301,
};